# ðŸ’¡ Universal VNV 2.0 â€” strict python-pip safety, aliases & functions

export VNV_PATH="$HOME/vnv"

function vnv_run_config() {
	if [[ -n "$VIRTUAL_ENV" ]]; then
		local ENV_NAME="$(basename "$VIRTUAL_ENV")"
		local CONFIG_FILE="$VNV_PATH/$ENV_NAME/config.sh"
		if [[ -f "$CONFIG_FILE" ]]; then
			source "$CONFIG_FILE"
			echo "âš™ï¸  Loaded config for $ENV_NAME"
		fi
	fi
}

function vnv_make_config() {
	if [[ -z "$VIRTUAL_ENV" ]]; then
		echo "[âŒ] No virtual environment is active. Activate one first."
		return 1
	fi

	local ENV_NAME="$(basename "$VIRTUAL_ENV")"
	local CONFIG_FILE="$VNV_PATH/$ENV_NAME/config.sh"

	mkdir -p "$(dirname "$CONFIG_FILE")"
	if [[ ! -f "$CONFIG_FILE" ]]; then
		echo "#!/usr/bin/env bash" > "$CONFIG_FILE"
		echo "# VNV per-environment configuration for '$ENV_NAME'" >> "$CONFIG_FILE"
	fi

	code "$CONFIG_FILE"
}

function vnv_set_prompt_hook() {
	vnv_remove_prompt_hook
	export VNV_OLD_PROMPT="$PS1"

	function vnv_update_prompt() {
		if [[ -n "$VIRTUAL_ENV" ]]; then
			PS1="${VNV_OLD_PROMPT}"
			while [[ "$PS1" =~ '^\([^)]*\)\ ' ]]; do
				PS1="$(echo "$PS1" | sed -E 's/^\([^)]*\) //')"
			done
			PS1="($(basename "$VIRTUAL_ENV")) $PS1"
		else
			PS1="$VNV_OLD_PROMPT"
		fi
	}

	autoload -U add-zsh-hook
	add-zsh-hook precmd vnv_update_prompt
}

function vnv_remove_prompt_hook() {
	if [[ -n "$VNV_OLD_PROMPT" ]]; then
		PS1="$VNV_OLD_PROMPT"
		unset VNV_OLD_PROMPT
	fi
	add-zsh-hook -d precmd vnv_update_prompt 2>/dev/null
}

function vnv_activate() {
	if [ -d "$1" ] && [ -f "$1/bin/activate" ]; then
		if [[ "$VIRTUAL_ENV" == "$1" ]]; then
			echo "âœ… Already using $(basename "$VIRTUAL_ENV")"
			return 0
		fi
		vnv_deactivate
		source "$1/bin/activate"
		vnv_run_config

		alias py      >/dev/null 2>&1 && alias py      >| "$VNV_PATH/.alias_py"
		alias python  >/dev/null 2>&1 && alias python  >| "$VNV_PATH/.alias_python"
		alias pip     >/dev/null 2>&1 && alias pip     >| "$VNV_PATH/.alias_pip"

		unalias py python pip 2>/dev/null

		alias py="$VIRTUAL_ENV/bin/python"
		alias python="$VIRTUAL_ENV/bin/python"
		alias pip="$VIRTUAL_ENV/bin/pip"

		vnvpy()  { "$VIRTUAL_ENV/bin/python" "$@"; }
		vnvpip() { "$VIRTUAL_ENV/bin/pip"    "$@"; }

		vnv_set_prompt_hook

		echo "âœ… Activated $(basename "$VIRTUAL_ENV") with $(vnvpy --version)"
	else
		echo "[âŒ] Environment '$1' does not exist or is invalid."
		return 1
	fi
}

function vnv_deactivate() {
	if [[ -n "$VIRTUAL_ENV" ]]; then
		ENV_NAME=$(basename "$VIRTUAL_ENV")
		unset -f vnvpy vnvpip 2>/dev/null

		[ -f "$VNV_PATH/.alias_py" ]     && source "$VNV_PATH/.alias_py"     && rm "$VNV_PATH/.alias_py"
		[ -f "$VNV_PATH/.alias_python" ] && source "$VNV_PATH/.alias_python" && rm "$VNV_PATH/.alias_python"
		[ -f "$VNV_PATH/.alias_pip" ]    && source "$VNV_PATH/.alias_pip"    && rm "$VNV_PATH/.alias_pip"

		vnv_remove_prompt_hook
		deactivate 2>/dev/null
		unset VIRTUAL_ENV
		PS1="$(echo "$PS1" | sed -E 's/^\([^)]*\) //')"

		echo "âŽ Deactivated $ENV_NAME and cleaned prompt."
	fi
}

function vnv_create() {
	mkdir -p "$VNV_PATH"
	$2 -m venv "$VNV_PATH/$1"
	vnv_activate "$VNV_PATH/$1"
	echo "âœ… Environment '$1' created at $VNV_PATH/$1."
}

function vnv_delete() {
	if [[ -z "$1" ]]; then
		echo "[âŒ] Please specify environment name to delete."
		return 1
	fi
	if [ -d "$VNV_PATH/$1" ]; then
		vnv_deactivate
		rm -rf "$VNV_PATH/$1"
		echo "âœ… Environment '$1' removed."
	else
		echo "[âŒ] Environment '$1' does not exist."
	fi
}

function select_python() {
	echo "ðŸ” Available Python versions:"
	AVAILABLE_PYTHONS=""
	for ver in 3.15 3.14 3.13 3.12 3.11 3.10 3.9; do
		if command -v python$ver >/dev/null 2>&1; then
			PY_PATH=$(command -v python$ver)
			AVAILABLE_PYTHONS="$AVAILABLE_PYTHONS $ver"
			echo "  - python$ver â†’ $PY_PATH"
		fi
	done

	DEFAULT_VER=$(echo "$AVAILABLE_PYTHONS" | awk '{print $1}')

	if [[ -z "$DEFAULT_VER" ]]; then
		echo "[âŒ] No known Python versions found!"
		return 1
	fi

	echo -n "Enter the python version (e.g. 3.15), or leave empty for latest [$DEFAULT_VER]: "
	read -r PYTHON_VER
	if [[ -z "$PYTHON_VER" ]]; then
		PYTHON_BIN="python$DEFAULT_VER"
	else
		if ! command -v python$PYTHON_VER >/dev/null 2>&1; then
			echo "[âŒ] python$PYTHON_VER not found!"
			return 1
		fi
		PYTHON_BIN="python$PYTHON_VER"
	fi

	echo "âœ” Using $($PYTHON_BIN --version) at $(command -v $PYTHON_BIN)"
}

function vnv_info() {
	if [[ -n "$VIRTUAL_ENV" ]]; then
		echo "Environment    : $(basename $VIRTUAL_ENV)"
		echo "Location       : $VIRTUAL_ENV"
		echo "Python version : $(vnvpy --version)"
		echo "Pip version    : $(vnvpip --version)"
	else
		echo "No virtual environment is active."
	fi
}

function vnv_packages() {
	if [[ -n "$VIRTUAL_ENV" ]]; then
		PACKAGES=$("$VIRTUAL_ENV/bin/pip" list --format=freeze | grep -v '^pip==' | grep -v '^setuptools==' | grep -v '^wheel==')
		if [[ -n "$PACKAGES" ]]; then
			printf "%-30s %-20s\n" "Package" "Version"
			printf "%-30s %-20s\n" "------------------------------" "--------------------"
			echo "$PACKAGES" | awk -F '==' '{printf "%-30s %-20s\n", $1, $2}'
		else
			echo "[â„¹ï¸] No installed packages except pip, setuptools, wheel."
		fi
	else
		echo "[âŒ] No virtual environment is active."
	fi
}

function vnv() {
	case "$1" in
		"++")
			select_python || return 1
			vnv_create "$2" "$PYTHON_BIN"
			;;
		"+")
			vnvpip install "$2"
			;;
		"install")
			vnvpip install -r "$2"
			;;
		"--")
			vnv_delete "$2"
			;;
		"-")
			if [ -n "$2" ]; then
				vnvpip uninstall -y "$2"
			else
				vnv_deactivate
			fi
			;;
		"list")
			echo "Environments in $VNV_PATH:"
			ls -1 "$VNV_PATH" | grep -vE '^\s*$'
			;;
		"info" | "?" | "")
			if [[ -n "$VIRTUAL_ENV" ]]; then
				typeset -f vnvpy  >/dev/null 2>&1 || vnvpy()  { "$VIRTUAL_ENV/bin/python" "$@"; }
				typeset -f vnvpip >/dev/null 2>&1 || vnvpip() { "$VIRTUAL_ENV/bin/pip"    "$@"; }
			fi
			vnv_info
			;;
		"freeze")
			vnvpip freeze > requirements.txt
			echo "requirements.txt created."
			;;
		"cd")
			cd "$VNV_PATH/$2"
			;;
		"pkg")
			vnv_packages "$2"
			;;
		"config")
			vnv_make_config
			;;

		*)
			vnv_activate "$VNV_PATH/$1"
			;;
	esac
}

# Auto reapply prompt if VIRTUAL_ENV is set on terminal reload
if [[ -n "$VIRTUAL_ENV" ]]; then
	vnv_set_prompt_hook
fi

# ðŸ›¡ï¸ Self-Healing: reapply aliases if env is active
if [[ -n "$VIRTUAL_ENV" ]]; then
	current_py="$(alias py 2>/dev/null | sed -E "s/alias py='(.*)'/\1/")"
	expected_py="$VIRTUAL_ENV/bin/python"

	if [[ "$current_py" != "$expected_py" ]]; then
		# Reapply venv-specific aliases
		unalias py python pip 2>/dev/null

		alias py="$expected_py"
		alias python="$expected_py"
		alias pip="$VIRTUAL_ENV/bin/pip"

		# Ensure vnvpy and vnvpip functions are alive
		typeset -f vnvpy  >/dev/null 2>&1 || vnvpy()  { "$expected_py" "$@"; }
		typeset -f vnvpip >/dev/null 2>&1 || vnvpip() { "$VIRTUAL_ENV/bin/pip" "$@"; }

		echo "âœ… Restored py/python/pip for active env: $(basename "$VIRTUAL_ENV")"
	fi
fi


